<VirtualHost *:443>
  ServerName pawtropolis.tech
  ServerAlias www.pawtropolis.tech

  # --- Static site root ---
  DocumentRoot /var/www/pawtropolis/website
  <Directory "/var/www/pawtropolis/website">
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted
  </Directory>

  # --- Security headers (safe defaults) ---
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"

  # --- Reverse proxy to Fastify (API & Auth) ---
  ProxyPreserveHost On
  ProxyPass        /api/  http://127.0.0.1:3000/api/
  ProxyPassReverse /api/  http://127.0.0.1:3000/api/
  ProxyPass        /auth/ http://127.0.0.1:3000/auth/
  ProxyPassReverse /auth/ http://127.0.0.1:3000/auth/

  # --- SPA fallback: all non-asset, non-API/AUTH paths â†’ index.html ---
  RewriteEngine On
  # Bypass rewrite for API/AUTH and static assets
  RewriteCond %{REQUEST_URI} ^/(api|auth)/ [OR]
  RewriteCond %{REQUEST_URI} \.(css|js|png|webp|jpg|jpeg|svg|ico|txt|json|map|webmanifest)$ [NC]
  RewriteRule ^ - [L]

  # Fallback everything else to the SPA entrypoint
  RewriteRule ^ /index.html [L]

  ErrorLog ${APACHE_LOG_DIR}/pawtropolis-error.log
  CustomLog ${APACHE_LOG_DIR}/pawtropolis-access.log combined

  # --- SSL Configuration (certbot will add these) ---
  # SSLEngine on
  # SSLCertificateFile /etc/letsencrypt/live/pawtropolis.tech/fullchain.pem
  # SSLCertificateKeyFile /etc/letsencrypt/live/pawtropolis.tech/privkey.pem
  # Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>

# HTTP to HTTPS redirect
<VirtualHost *:80>
  ServerName pawtropolis.tech
  ServerAlias www.pawtropolis.tech

  RewriteEngine On
  RewriteCond %{HTTPS} off
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>
