<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Glass System Test</title>
    <style>
      body {
        margin: 0;
        padding: 2rem;
        background: #0f1218;
        color: #e7ecf3;
        font-family: system-ui, sans-serif;
      }
      .test-card {
        width: 300px;
        height: 200px;
        padding: 2rem;
        margin: 2rem;
        border-radius: 12px;
        background: #171b22;
        border: 1px solid #2a303b;
      }
      .glass-surface {
        position: relative;
        overflow: hidden;
        isolation: isolate;
        background: linear-gradient(180deg, rgba(88, 101, 242, 0.08), rgba(235, 69, 158, 0.06));
        border: 1px solid rgba(88, 101, 242, 0.3) !important;
        backdrop-filter: blur(14px) saturate(1.15) brightness(1.08);
      }
      .glass-canvas {
        position: absolute;
        inset: 0;
        z-index: 0;
        pointer-events: none;
      }
      .glass-content {
        position: relative;
        z-index: 1;
      }
      pre {
        background: #000;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
      }
      .status {
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 8px;
      }
      .status.ok {
        background: #1a472a;
        color: #57f287;
      }
      .status.error {
        background: #4a1a1a;
        color: #f38ba8;
      }
    </style>

    <!-- React & Three CDN -->
    <script type="module">
      if (!window.__R3F_LOADED__) {
        window.__R3F_LOADED__ = true;
        const preloads = [
          "https://esm.sh/react@18?external=react-dom",
          "https://esm.sh/react-dom@18/client",
          "https://esm.sh/three@0.161",
          "https://esm.sh/@react-three/fiber@8?external=react,react-dom,three",
          "https://esm.sh/@react-three/drei@9?external=react,react-dom,three,@react-three/fiber",
          "https://esm.sh/maath@0.10?external=three",
        ];
        preloads.forEach((href) => {
          const l = document.createElement("link");
          l.rel = "modulepreload";
          l.href = href;
          document.head.appendChild(l);
        });
      }
    </script>
  </head>
  <body>
    <h1>Liquid Glass System Test</h1>

    <div id="diagnostics">
      <h2>Diagnostics</h2>
      <div id="webgl-status"></div>
      <div id="motion-status"></div>
      <div id="modules-status"></div>
    </div>

    <h2>Test Cards</h2>

    <div class="test-card glass-surface" data-glass="lens" data-intensity="0.7">
      <div class="glass-content">
        <h3>Lens Mode</h3>
        <p>Should show 3D lens geometry</p>
      </div>
    </div>

    <div class="test-card glass-surface" data-glass="bar" data-intensity="0.6">
      <div class="glass-content">
        <h3>Bar Mode</h3>
        <p>Should show 3D bar geometry</p>
      </div>
    </div>

    <div class="test-card glass-surface" data-glass="cube" data-intensity="0.5">
      <div class="glass-content">
        <h3>Cube Mode</h3>
        <p>Should show 3D cube geometry</p>
      </div>
    </div>

    <div class="test-card" style="background: #171b22">
      <h3>No Glass (Control)</h3>
      <p>Normal card without any effects</p>
    </div>

    <h2>Console Output</h2>
    <pre id="console-output"></pre>

    <script type="module">
      const output = document.getElementById("console-output");
      const log = (msg) => {
        console.log(msg);
        output.textContent += msg + "\n";
      };

      // WebGL check
      const webglStatus = document.getElementById("webgl-status");
      try {
        const canvas = document.createElement("canvas");
        const gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
        if (gl) {
          webglStatus.className = "status ok";
          webglStatus.textContent = "✓ WebGL is supported";
          log("[OK] WebGL available");
        } else {
          webglStatus.className = "status error";
          webglStatus.textContent = "✗ WebGL not supported";
          log("[ERROR] WebGL not available");
        }
        canvas.remove();
      } catch (e) {
        webglStatus.className = "status error";
        webglStatus.textContent = "✗ WebGL check failed: " + e.message;
        log("[ERROR] WebGL check failed: " + e.message);
      }

      // Motion preference check
      const motionStatus = document.getElementById("motion-status");
      const prefersReduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      if (prefersReduced) {
        motionStatus.className = "status error";
        motionStatus.textContent = "⚠ Reduced motion is enabled (3D disabled)";
        log("[WARNING] prefers-reduced-motion: reduce detected");
      } else {
        motionStatus.className = "status ok";
        motionStatus.textContent = "✓ Motion animations enabled";
        log("[OK] Motion enabled");
      }

      // Try to load glass system
      const modulesStatus = document.getElementById("modules-status");
      log("Attempting to load glass/init.js...");

      import("/glass/init.js")
        .then(() => {
          modulesStatus.className = "status ok";
          modulesStatus.textContent = "✓ Glass modules loaded successfully";
          log("[OK] Glass init.js loaded");

          setTimeout(() => {
            const mounted = document.querySelectorAll('[data-glass-mounted="true"]').length;
            log(`[INFO] Islands mounted: ${mounted}`);
            if (mounted === 0) {
              log("[WARNING] No islands were mounted - check console for errors");
            }
          }, 2000);
        })
        .catch((err) => {
          modulesStatus.className = "status error";
          modulesStatus.textContent = "✗ Failed to load glass modules: " + err.message;
          log("[ERROR] Failed to load glass/init.js: " + err.message);
          log(err.stack);
        });

      // Capture console errors
      window.addEventListener("error", (e) => {
        log("[ERROR] " + e.message + " at " + e.filename + ":" + e.lineno);
      });

      window.addEventListener("unhandledrejection", (e) => {
        log("[PROMISE ERROR] " + e.reason);
      });
    </script>
  </body>
</html>
